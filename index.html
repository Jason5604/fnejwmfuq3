<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>高二期末查分</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:16px;
}
.container{width:100%;max-width:1200px}

.search-card,.result-card{
    background:rgba(255,255,255,.95);
    border-radius:20px;
    padding:48px 40px;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
}

.search-card{text-align:center}

h1{
    font-size:42px;
    margin-bottom:28px;
    line-height:1.3;
}

input[type=text]{
    width:100%;
    padding:16px;
    border-radius:12px;
    border:2px solid #e5e5e7;
    font-size:16px;
}

.search-btn{
    margin-top:20px;
    padding:14px 40px;
    border:none;
    border-radius:12px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#fff;
    font-size:16px;
    cursor:pointer;
}

.search-btn:disabled{opacity:.5}

.result-card{display:none}

.student-info{
    display:flex;
    justify-content:space-between;
    gap:20px;
    padding:24px;
    background:linear-gradient(135deg,#f5f7fa,#c3cfe2);
    border-radius:16px;
    margin-bottom:24px;
}

.student-info h2{
    font-size:28px;
    margin-bottom:8px;
}

.student-info div{
    font-size:15px;
    line-height:1.6;
}

.total-score-section{text-align:right}

#totalScore{
    font-size:48px;
    font-weight:700;
    color:#667eea;
}

#totalRank{
    font-size:18px;
    color:#667eea;
}

.scores-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:16px;
}

.score-item{
    background:#fff;
    padding:20px;
    border-radius:12px;
    border:2px solid #f5f5f7;
}

.score-item h2{
    font-size:32px;
    margin:6px 0;
}

.subject-name{color:#6e6e73}
.rank-info{color:#667eea;font-size:14px}

.back-btn{
    margin-top:28px;
    padding:12px 32px;
    border-radius:12px;
    border:2px solid #667eea;
    background:transparent;
    color:#667eea;
    cursor:pointer;
}

@media (max-width:768px){
    .search-card,.result-card{
        padding:28px 20px;
        border-radius:16px;
    }
    h1{font-size:26px}
    .student-info{
        flex-direction:column;
        text-align:left;
    }
    .total-score-section{
        text-align:left;
    }
    #totalScore{
        font-size:36px;
    }
    .scores-grid{
        grid-template-columns:repeat(2,1fr);
    }
}

@media (max-width:480px){
    .scores-grid{
        grid-template-columns:1fr;
    }
}
</style>
</head>

<body>
<div class="container">

<div class="search-card" id="searchCard">
    <h1>梅州兴宁高二期末成绩查询系统</h1>
    <input type="text" id="searchInput" placeholder="姓名或考号" disabled>
    <button class="search-btn" id="searchBtn" onclick="searchScore()" disabled>查询</button>
</div>

<div class="result-card" id="resultCard">
    <div class="student-info">
        <div>
            <h2 id="studentName"></h2>
            <div id="studentId"></div>
            <div id="studentSchool"></div>
            <div id="studentClass"></div>
            <div id="studentSubject"></div>
        </div>
        <div class="total-score-section">
            <div id="totalScore"></div>
            <div id="totalRank"></div>
        </div>
    </div>

    <div class="scores-grid" id="scoresGrid"></div>
    <button class="back-btn" onclick="backToSearch()">返回</button>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let studentsData=[]
function v(c){return c==null?"":String(c).trim()}

function parseHeader(rows){
    const map={}
    let last=null
    rows.forEach(r=>{
        r.forEach((c,i)=>{
            const t=v(c)
            if(!t)return
            if(/语文|数学|英语|物理|历史|化学|生物|政治|地理/.test(t)){
                map[t]??={}
                map[t].score=i
                last=t
            }
            if(t.includes("排名")){
                if(last) map[last].rank=i
                else map.totalRank=i
            }
        })
    })
    return map
}

function parseStudent(row,h){
    if(!v(row[3]))return null
    const s={
        school:v(row[0]),
        class:v(row[1]),
        id:v(row[2]),
        name:v(row[3]),
        subject:v(row[4]),
        totalScore:row[5]||0,
        totalRank:h.totalRank?v(row[h.totalRank]):"",
        scores:{}
    }
    Object.keys(h).forEach(k=>{
        if(k==="totalRank")return
        const sc=parseFloat(row[h[k].score])
        if(!isNaN(sc)){
            s.scores[k]={score:sc,rank:h[k].rank?v(row[h[k].rank]):""}
        }
    })
    return s
}

window.addEventListener("DOMContentLoaded",async()=>{
    const res=await fetch("./merged.xlsx")
    const buf=await res.arrayBuffer()
    const wb=XLSX.read(buf,{type:"array"})
    wb.SheetNames.forEach(n=>{
        const rows=XLSX.utils.sheet_to_json(wb.Sheets[n],{header:1})
        const h=parseHeader(rows.slice(0,3))
        for(let i=3;i<rows.length;i++){
            const s=parseStudent(rows[i],h)
            if(s) studentsData.push(s)
        }
    })
    searchInput.disabled=false
    searchBtn.disabled=false
})

function searchScore(){
    const key=searchInput.value.trim()
    if(!key)return
    let list=/^\d+$/.test(key)
        ?studentsData.filter(s=>s.id===key)
        :studentsData.filter(s=>s.name===key)
    if(list.length===0){alert("未找到");return}
    if(list.length===1){displayResult(list[0]);return}
    let msg=`发现 ${list.length} 个同名学生：\n\n`
    list.forEach((s,i)=>{
        msg+=`${i+1}. ${s.name} | ${s.id} | ${s.class} | ${s.school}\n`
    })
    const n=parseInt(prompt(msg+"请输入序号："))
    if(n>=1&&n<=list.length) displayResult(list[n-1])
}

function displayResult(s){
    searchCard.style.display="none"
    resultCard.style.display="block"
    studentName.textContent=s.name
    studentId.textContent="考号："+s.id
    studentSchool.textContent="学校："+s.school
    studentClass.textContent="班级："+s.class
    studentSubject.textContent="选科："+s.subject
    totalScore.textContent=s.totalScore
    totalRank.textContent=s.totalRank?`排名：${s.totalRank}`:""
    scoresGrid.innerHTML=""
    Object.keys(s.scores).forEach(k=>{
        scoresGrid.innerHTML+=`
        <div class="score-item">
            <div class="subject-name">${k}</div>
            <h2>${s.scores[k].score}</h2>
            ${s.scores[k].rank?`<div class="rank-info">排名：${s.scores[k].rank}</div>`:""}
        </div>`
    })
}

function backToSearch(){
    resultCard.style.display="none"
    searchCard.style.display="block"
}
</script>
</body>
</html>
