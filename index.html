<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>È´ò‰∫åÊúüÊú´Êü•ÂàÜ</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.container {
    width: 100%;
    max-width: 1400px;
}

.search-card, .result-card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 24px;
    padding: 50px 45px;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.search-card {
    text-align: center;
}

h1 {
    font-size: 46px;
    margin-bottom: 32px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
}

.loading-section {
    margin-bottom: 28px;
    padding: 28px;
    background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
    border-radius: 16px;
    border: 2px solid #667eea;
}

.status-msg {
    color: #764ba2;
    font-size: 16px;
    font-weight: 600;
}

input[type=text] {
    width: 100%;
    padding: 18px 20px;
    border-radius: 14px;
    border: 2px solid #e5e7eb;
    font-size: 17px;
    transition: all 0.3s ease;
    background: #fff;
}

input[type=text]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.search-btn {
    margin-top: 24px;
    padding: 16px 48px;
    border: none;
    border-radius: 14px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.search-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.search-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.result-card {
    display: none;
}

.student-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 40px;
    border-radius: 20px;
    color: white;
    margin-bottom: 32px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.student-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
}

.student-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    position: relative;
    z-index: 1;
}

.info-left h2 {
    font-size: 36px;
    margin-bottom: 16px;
    font-weight: 700;
}

.info-detail {
    font-size: 16px;
    margin: 8px 0;
    opacity: 0.95;
}

.total-score-box {
    text-align: right;
}

.score-label {
    font-size: 16px;
    opacity: 0.9;
    margin-bottom: 8px;
}

.total-score-number {
    font-size: 64px;
    font-weight: 800;
    line-height: 1;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.rank-badges {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    justify-content: flex-end;
}

.rank-badge {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.scores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.score-card {
    background: #fff;
    padding: 28px;
    border-radius: 18px;
    border: 2px solid #f0f0f0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.score-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.score-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.2);
    border-color: #667eea;
}

.score-card:hover::before {
    transform: scaleX(1);
}

.subject-name {
    font-size: 18px;
    color: #6b7280;
    font-weight: 600;
    margin-bottom: 12px;
}

.score-display {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 12px;
}

.main-score {
    font-size: 42px;
    font-weight: 800;
    color: #1f2937;
}

.original-score {
    font-size: 18px;
    color: #9ca3af;
    font-weight: 500;
}

.score-type-label {
    display: inline-block;
    padding: 4px 10px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
}

.rank-info-box {
    display: flex;
    gap: 10px;
    margin-top: 12px;
}

.rank-pill {
    flex: 1;
    background: #f3f4f6;
    padding: 8px 12px;
    border-radius: 10px;
    text-align: center;
}

.rank-pill-label {
    font-size: 11px;
    color: #6b7280;
    font-weight: 600;
    margin-bottom: 4px;
}

.rank-pill-value {
    font-size: 16px;
    color: #667eea;
    font-weight: 700;
}

.back-btn {
    margin-top: 32px;
    padding: 14px 40px;
    border-radius: 14px;
    border: 2px solid #667eea;
    background: transparent;
    color: #667eea;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

@media (max-width: 768px) {
    .search-card, .result-card {
        padding: 32px 24px;
        border-radius: 20px;
    }
    
    h1 {
        font-size: 32px;
    }
    
    .student-info-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .total-score-box {
        text-align: left;
    }
    
    .rank-badges {
        justify-content: flex-start;
    }
    
    .total-score-number {
        font-size: 48px;
    }
    
    .scores-grid {
        grid-template-columns: 1fr;
    }
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(102, 126, 234, 0.3);
    border-radius: 50%;
    border-top-color: #667eea;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.score-card {
    animation: slideInUp 0.5s ease-out backwards;
}

.score-card:nth-child(1) { animation-delay: 0.1s; }
.score-card:nth-child(2) { animation-delay: 0.2s; }
.score-card:nth-child(3) { animation-delay: 0.3s; }
.score-card:nth-child(4) { animation-delay: 0.4s; }
.score-card:nth-child(5) { animation-delay: 0.5s; }
.score-card:nth-child(6) { animation-delay: 0.6s; }
.score-card:nth-child(7) { animation-delay: 0.7s; }
.score-card:nth-child(8) { animation-delay: 0.8s; }

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
</head>

<body>
<div class="container">

<div class="search-card" id="searchCard">
    <h1>Ê¢ÖÂ∑ûÂÖ¥ÂÆÅÈ´ò‰∫åÊúüÊú´ÊàêÁª©Êü•ËØ¢ by@Âè∂Â§©Âì≤</h1>
    
    <div class="loading-section">
        <div class="status-msg" id="statusMsg"><div class="loading"></div> Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆÂ∫ì...</div>
    </div>
    
    <input type="text" id="searchInput" placeholder="ËØ∑Á≠âÂæÖÊï∞ÊçÆÂ∫ìÂä†ËΩΩÂÆåÊàê" disabled>
    <button class="search-btn" id="searchBtn" onclick="searchScore()" disabled>üîç Êü•ËØ¢ÊàêÁª©</button>
</div>

<div class="result-card" id="resultCard">
    <div class="student-header">
        <div class="student-info-grid">
            <div class="info-left">
                <h2 id="studentName"></h2>
                <div class="info-detail" id="studentId"></div>
                <div class="info-detail" id="studentSchool"></div>
                <div class="info-detail" id="studentClass"></div>
                <div class="info-detail" id="studentSubject"></div>
            </div>
            <div class="total-score-box">
                <div class="score-label">ÊÄªÂàÜ</div>
                <div class="total-score-number" id="totalScore"></div>
                <div class="rank-badges" id="totalRankBadges"></div>
            </div>
        </div>
    </div>

    <div class="scores-grid" id="scoresGrid"></div>
    <button class="back-btn" onclick="backToSearch()">‚Üê ËøîÂõûÊü•ËØ¢</button>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let studentsData = [];

function v(c) {
    return c == null ? "" : String(c).trim();
}

function parseHeader(rows) {
    const map = {};
    
    const row2 = rows[1] || [];
    const row3 = rows[2] || [];
    
    row2.forEach((cell, i) => {
        const t = v(cell);
        if (!t) return;
        
        const subjectMatch = t.match(/(ËØ≠Êñá|Êï∞Â≠¶|Ëã±ËØ≠|Áâ©ÁêÜ|ÂéÜÂè≤|ÂåñÂ≠¶|ÁîüÁâ©|ÊîøÊ≤ª|Âú∞ÁêÜ|‰øÑËØ≠|Êó•ËØ≠|ÊÄªÂàÜ[^)]*)/);
        if (subjectMatch) {
            const isGraded = t.includes("(ËµãÂàÜ)");
            const subjectBase = subjectMatch[1].replace(/\(ËµãÂàÜ\)/g, '');
            
            if (!map[subjectBase]) {
                map[subjectBase] = {
                    hasGraded: false,
                    hasOriginal: false
                };
            }
            
            if (isGraded) {
                map[subjectBase].hasGraded = true;
                map[subjectBase].gradedStart = i;
            } else if (!t.includes("ÊÄªÂàÜ") || t === subjectMatch[1]) {
                map[subjectBase].hasOriginal = true;
                map[subjectBase].originalStart = i;
            }
        }
    });
    
    row3.forEach((cell, i) => {
        const t = v(cell);
        if (!t) return;
        
        let belongsToSubject = null;
        let isGraded = false;
        
        for (let j = i; j >= 0; j--) {
            const subjectCell = v(row2[j]);
            if (subjectCell) {
                const match = subjectCell.match(/(ËØ≠Êñá|Êï∞Â≠¶|Ëã±ËØ≠|Áâ©ÁêÜ|ÂéÜÂè≤|ÂåñÂ≠¶|ÁîüÁâ©|ÊîøÊ≤ª|Âú∞ÁêÜ|‰øÑËØ≠|Êó•ËØ≠|ÊÄªÂàÜ[^)]*)/);
                if (match) {
                    belongsToSubject = match[1].replace(/\(ËµãÂàÜ\)/g, '');
                    isGraded = subjectCell.includes("(ËµãÂàÜ)");
                    break;
                }
            }
        }
        
        if (belongsToSubject && map[belongsToSubject]) {
            const prefix = isGraded ? 'graded' : 'original';
            
            if (t === "ÂàÜÊï∞") {
                map[belongsToSubject][prefix + 'Score'] = i;
            } else if (t.includes("ÊñπÂêëÊ†°ÂêçÊ¨°")) {
                map[belongsToSubject][prefix + 'SchoolRank'] = i;
            } else if (t.includes("ÊñπÂêëÁè≠ÂêçÊ¨°")) {
                map[belongsToSubject][prefix + 'ClassRank'] = i;
            }
        }
    });
    
    return map;
}

function parseStudent(row, h) {
    if (!v(row[3])) return null;
    
    const s = {
        school: v(row[0]),
        class: v(row[1]),
        id: v(row[2]),
        name: v(row[3]),
        subject: v(row[4]),
        totalScore: 0,
        totalOriginalScore: 0,
        totalSchoolRank: "",
        totalClassRank: "",
        scores: {}
    };
    
    Object.keys(h).forEach(k => {
        if (k.includes("ÊÄªÂàÜ")) {
            if (h[k].gradedScore !== undefined) {
                const score = parseFloat(row[h[k].gradedScore]);
                if (!isNaN(score)) {
                    s.totalScore = score;
                    if (h[k].gradedSchoolRank) s.totalSchoolRank = v(row[h[k].gradedSchoolRank]);
                    if (h[k].gradedClassRank) s.totalClassRank = v(row[h[k].gradedClassRank]);
                }
            }
            if (h[k].originalScore !== undefined) {
                const score = parseFloat(row[h[k].originalScore]);
                if (!isNaN(score)) {
                    s.totalOriginalScore = score;
                    if (!s.totalScore) {
                        s.totalScore = score;
                        if (h[k].originalSchoolRank) s.totalSchoolRank = v(row[h[k].originalSchoolRank]);
                        if (h[k].originalClassRank) s.totalClassRank = v(row[h[k].originalClassRank]);
                    }
                }
            }
        }
    });
    
    Object.keys(h).forEach(k => {
        if (k.includes("ÊÄªÂàÜ")) return;
        
        const subjectData = {};
        
        if (h[k].gradedScore !== undefined) {
            const score = parseFloat(row[h[k].gradedScore]);
            if (!isNaN(score)) {
                subjectData.gradedScore = score;
                subjectData.schoolRank = h[k].gradedSchoolRank ? v(row[h[k].gradedSchoolRank]) : "";
                subjectData.classRank = h[k].gradedClassRank ? v(row[h[k].gradedClassRank]) : "";
            }
        }
        
        if (h[k].originalScore !== undefined) {
            const score = parseFloat(row[h[k].originalScore]);
            if (!isNaN(score)) {
                subjectData.originalScore = score;
                if (!subjectData.gradedScore) {
                    subjectData.schoolRank = h[k].originalSchoolRank ? v(row[h[k].originalSchoolRank]) : "";
                    subjectData.classRank = h[k].originalClassRank ? v(row[h[k].originalClassRank]) : "";
                }
            }
        }
        
        if (Object.keys(subjectData).length > 0) {
            s.scores[k] = subjectData;
        }
    });
    
    return s;
}

window.addEventListener("DOMContentLoaded", async () => {
    try {
        const res = await fetch("./merged.xlsx");
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, {type: "array"});
        
        studentsData = [];
        
        wb.SheetNames.forEach(n => {
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[n], {header: 1});
            const h = parseHeader(rows.slice(0, 3));
            
            for (let i = 3; i < rows.length; i++) {
                const s = parseStudent(rows[i], h);
                if (s) {
                    studentsData.push(s);
                }
            }
        });
        
        document.getElementById('statusMsg').textContent = `‚úì Êï∞ÊçÆÂ∫ìÂä†ËΩΩÂÆåÊàê`;
        document.getElementById('searchInput').disabled = false;
        document.getElementById('searchInput').placeholder = 'ËæìÂÖ•ÂßìÂêçÊàñËÄÉÂè∑Êü•ËØ¢';
        document.getElementById('searchBtn').disabled = false;
        
    } catch (error) {
        document.getElementById('statusMsg').textContent = '‚úó Êï∞ÊçÆÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
    }
});

function searchScore() {
    const key = document.getElementById('searchInput').value.trim();
    if (!key) {
        alert('ËØ∑ËæìÂÖ•ÂßìÂêçÊàñËÄÉÂè∑');
        return;
    }
    
    let list = /^\d+$/.test(key)
        ? studentsData.filter(s => s.id === key)
        : studentsData.filter(s => s.name === key);
    
    if (list.length === 0) {
        alert("Êú™ÊâæÂà∞ËØ•Â≠¶Áîü‰ø°ÊÅØ");
        return;
    }
    
    if (list.length === 1) {
        displayResult(list[0]);
        return;
    }
    
    let msg = `ÂèëÁé∞ ${list.length} ‰∏™ÂåπÈÖçÁªìÊûúÔºö\n\n`;
    list.forEach((s, i) => {
        msg += `${i + 1}. ${s.name} | ${s.id} | ${s.class} | ${s.school}\n`;
    });
    
    const n = parseInt(prompt(msg + "ËØ∑ËæìÂÖ•Â∫èÂè∑Ôºö"));
    if (n >= 1 && n <= list.length) {
        displayResult(list[n - 1]);
    }
}

function displayResult(s) {
    document.getElementById('searchCard').style.display = "none";
    document.getElementById('resultCard').style.display = "block";
    
    document.getElementById('studentName').textContent = s.name;
    document.getElementById('studentId').textContent = "üìã ËÄÉÂè∑Ôºö" + s.id;
    document.getElementById('studentSchool').textContent = "üè´ Â≠¶Ê†°Ôºö" + s.school;
    document.getElementById('studentClass').textContent = "üìö Áè≠Á∫ßÔºö" + s.class;
    document.getElementById('studentSubject').textContent = "üìñ ÈÄâÁßëÔºö" + s.subject;
    
    let totalScoreHtml = s.totalScore;
    if (s.totalOriginalScore && s.totalOriginalScore !== s.totalScore) {
        totalScoreHtml += `<div style="font-size:18px;opacity:0.8;margin-top:8px;">ÂéüÂßãÂàÜ: ${s.totalOriginalScore}</div>`;
    }
    document.getElementById('totalScore').innerHTML = totalScoreHtml;
    
    let rankBadgesHtml = '';
    if (s.totalSchoolRank) {
        rankBadgesHtml += `<div class="rank-badge">ÊñπÂêëÊéíÂêç: ${s.totalSchoolRank}</div>`;
    }
    if (s.totalClassRank) {
        rankBadgesHtml += `<div class="rank-badge">Áè≠Á∫ßÊéíÂêç: ${s.totalClassRank}</div>`;
    }
    document.getElementById('totalRankBadges').innerHTML = rankBadgesHtml;
    
    const scoresGrid = document.getElementById('scoresGrid');
    scoresGrid.innerHTML = "";
    
    Object.keys(s.scores).forEach(k => {
        const subject = s.scores[k];
        let scoreDisplayHtml = '';
        
        if (subject.gradedScore !== undefined) {
            scoreDisplayHtml = `
                <div class="score-display">
                    <span class="main-score">${subject.gradedScore}</span>
                    <span class="score-type-label">ËµãÂàÜ</span>
                </div>`;
            if (subject.originalScore !== undefined) {
                scoreDisplayHtml += `<div class="original-score">ÂéüÂßãÂàÜ: ${subject.originalScore}</div>`;
            }
        } else if (subject.originalScore !== undefined) {
            scoreDisplayHtml = `
                <div class="score-display">
                    <span class="main-score">${subject.originalScore}</span>
                </div>`;
        }
        
        let rankInfoHtml = '';
        if (subject.schoolRank || subject.classRank) {
            rankInfoHtml = '<div class="rank-info-box">';
            if (subject.schoolRank) {
                rankInfoHtml += `
                    <div class="rank-pill">
                        <div class="rank-pill-label">ÊñπÂêëÊéíÂêç</div>
                        <div class="rank-pill-value">${subject.schoolRank}</div>
                    </div>`;
            }
            if (subject.classRank) {
                rankInfoHtml += `
                    <div class="rank-pill">
                        <div class="rank-pill-label">Áè≠Á∫ßÊéíÂêç</div>
                        <div class="rank-pill-value">${subject.classRank}</div>
                    </div>`;
            }
            rankInfoHtml += '</div>';
        }
        
        scoresGrid.innerHTML += `
            <div class="score-card">
                <div class="subject-name">${k}</div>
                ${scoreDisplayHtml}
                ${rankInfoHtml}
            </div>`;
    });
}

function backToSearch() {
    document.getElementById('resultCard').style.display = "none";
    document.getElementById('searchCard').style.display = "block";
}

document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !this.disabled) {
        searchScore();
    }
});
</script>
</body>
</html>

